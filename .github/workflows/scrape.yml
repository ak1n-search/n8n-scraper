# .github/workflows/scrape.yml

name: Scrape Substack with Puppeteer (Base64)

on:
  repository_dispatch:
    types: [n8n-trigger]

jobs:
  scrape-and-return:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Puppeteer & Stealth libraries
        run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth

      - name: Run Puppeteer and Scrape Data
        id: scrape_step 
        run: |
          # Decode the Base64 script and pipe it into Node.js to execute
          scraped_json=$(echo "Y29uc3QgcHVwcGV0ZWVyID0gcmVxdWlyZSgncHVwcGV0ZWVyLWV4dHJhJyk7Cgpjb25zdCBTdGVhbHRoUGx1Z2luID0gcmVxdWlyZSgncHVwcGV0ZWVyLWV4dHJhLXBsdWdpbi1zdGVhbHRoJyk7CnB1cHBldGVlci51c2UoU3RlYWx0aFBsdWdpbigpKTsKCgphc3luYyBmdW5jdGlvbiBydW4oKSB7CiAgbGV0IGJyb3dzZXI7CiAgdHJ5IHsKICAgIGJyb3dzZXIgPSBhd2FpdCBwdXBwZXRlZXIubGF1bmNoKHsgaGVhZGxlc3M6IHRydWUsIGFyZ3M6IFsnLS1uby1zYW5kYm94J10gfSk7CiAgICBjb25zdCBwYWdlID0gYXdhaXQgYnJvd3Nlci5uZXdQYWdlKCk7CiAgICAKICAgIGF3YWl0IHBhZ2UuZ290bygnaHR0cHM6Ly9zdWJzdGFjay5jb20vc2VhcmNoL2JhbmplcmNpdG8/c2VhcmNoaW5nPWFsbF9wb3N0cycsIHsgd2FpdFVudGlsOiAnZG9tY29udGVudGxvYWRlZCcgfSk7CiAgICAKICAgIGF3YWl0IHBhZ2Uud2FpdEZvclNlbGVjdG9yKCdbZGF0YS10ZXN0aWQ9XCJwb3N0LXByZXZpZXctdGl0bGVcIl0nLCB7IHRpbWVvdXQ6IDQ1MDAwIH0pOwoKICAgIGNvbnN0IHRpdGxlcyA9IGF3YWl0IHBhZ2UuJCRldmFsKCdbZGF0YS10ZXN0aWQ9XCJwb3N0LXByZXZpZXctdGl0bGVcIl0nLCBlbGVtZW50cyA9PiBlbGVtZW50cy5tYXAoZWwgPT4gZWwuaW5uZXJUZXh0KSk7CiAgICAKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aXRsZXMpOwoKICB9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUubmFtZSwgZS5tZXNzYWdlKTsKICAgIHJldHVybiAnW10nOwogIH0gZmluYWxseSB7CiAgICBpZiAoYnJvd3NlcikgewogICAgICBhd2FpdCBicm93c2VyLmNsb3NlKCk7CiAgICB9CiAgfQp9CgpydW4oKS50aGVuKGNvbnNvbGUubG9vZyk7" | base64 --decode | node)
          echo "scraped_json=$scraped_json" >> $GITHUB_OUTPUT

      - name: Send data to n8n
        run: |
          curl -X POST -H "Content-TYPE": "application/json" \
          -d "{\"postTitles\": ${{ steps.scrape_step.outputs.scraped_json }} }" \
          "${{ secrets.N8N_WEBHOOK_URL }}"
